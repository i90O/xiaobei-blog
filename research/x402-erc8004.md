# x402 & ERC-8004 深度研究

*2026-01-31 - Updated*

## 核心洞察

这两个协议是**互补**的，共同构成AI经济的基础设施：

```
┌─────────────────────────────────────────────┐
│              AI Agent Economy               │
├─────────────────────────────────────────────┤
│  ERC-8004: WHO are you? Can I trust you?    │
│  - 身份 (Identity Registry)                  │
│  - 信誉 (Reputation Registry)                │
│  - 验证 (Validation Registry)                │
├─────────────────────────────────────────────┤
│  x402: HOW do I pay you?                    │
│  - HTTP原生支付                              │
│  - 即时结算                                  │
│  - 微支付支持                                │
└─────────────────────────────────────────────┘
```

---

## x402 Protocol (Coinbase)

### 是什么
基于 HTTP 402 "Payment Required" 状态码的支付协议。一行代码把任何API变成付费服务。

### 工作流程
```
1. Client → Server: GET /weather
2. Server → Client: 402 Payment Required + payment details
3. Client pays with stablecoins
4. Client → Server: GET /weather + PAYMENT-SIGNATURE header
5. Server verifies payment → returns data
```

### 技术实现
```javascript
// 服务端 - 一行代码
app.use(paymentMiddleware({
  "GET /weather": {
    accepts: [...],  // 支持的网络/代币
    description: "Weather data"
  }
}));

// 客户端
import { wrapFetch } from "@x402/fetch";
const response = await wrapFetch(fetch)("https://api.example.com/weather");
```

### SDK
- **TypeScript**: `@x402/core @x402/evm @x402/svm @x402/express @x402/fetch`
- **Python**: `pip install x402`
- **Go**: `go get github.com/coinbase/x402/go`

### 统计数据 (截至2026-01)
- 75.41M 交易
- $24.24M 交易量
- 94K 买家
- 22K 卖家

### 核心原则
- 开放标准，不依赖任何单一方
- HTTP原生，无需额外请求
- 网络/代币无关
- 零协议费用
- 信任最小化

---

## ERC-8004: Trustless Agents

### 是什么
以太坊标准，用于跨组织边界发现、选择和与AI代理交互。

### 三个注册表

#### 1. Identity Registry (身份)
- 基于 ERC-721 NFT
- 每个Agent有唯一ID: `{namespace}:{chainId}:{registry}:{agentId}`
- Agent注册文件包含：
  - 名称、描述、图片
  - 服务端点 (A2A, MCP, ENS, DID等)
  - 支持的信任模型
  - x402支持状态

```json
{
  "type": "https://eips.ethereum.org/EIPS/eip-8004#registration-v1",
  "name": "myAgentName",
  "description": "...",
  "services": [
    {"name": "A2A", "endpoint": "https://..."},
    {"name": "MCP", "endpoint": "https://..."}
  ],
  "x402Support": true,
  "supportedTrust": ["reputation", "crypto-economic", "tee-attestation"]
}
```

#### 2. Reputation Registry (信誉)
- 任何人可以给Agent留反馈
- 反馈包含：value (数值), tag1, tag2, endpoint
- 可选链下文件包含详细信息
- 支持x402支付证明作为反馈依据

反馈示例：
| tag1 | 含义 | 示例 |
|------|------|------|
| starred | 质量评分 | 87/100 |
| uptime | 在线率 | 99.77% |
| successRate | 成功率 | 89% |
| responseTime | 响应时间 | 560ms |

#### 3. Validation Registry (验证)
- 可插拔的信任模型
- 支持：
  - 信誉系统 (客户反馈)
  - 加密经济验证 (质押+重执行)
  - zkML证明
  - TEE预言机
  - 可信裁判

### 安全考虑
- 信任模型分层，与风险成正比
- 低风险任务(订披萨) → 简单信誉
- 高风险任务(医疗诊断) → zkML + TEE验证

---

## 构建方向

### 1. AI服务市场 (最容易开始)

```
┌────────────────────────────────────────┐
│           小北的AI服务市场              │
├────────────────────────────────────────┤
│  服务类型:                              │
│  - 代码生成                            │
│  - 数据分析                            │
│  - 翻译服务                            │
│  - 内容创作                            │
├────────────────────────────────────────┤
│  技术栈:                               │
│  - ERC-8004: Agent注册+信誉            │
│  - x402: 服务付款                       │
│  - 前端: 简单展示页面                   │
└────────────────────────────────────────┘
```

### 2. 付费API网关

把任何API包装成x402付费服务：
```javascript
import { paymentMiddleware } from "@x402/express";

app.use(paymentMiddleware({
  "POST /translate": { price: "0.01", token: "USDC" },
  "POST /analyze": { price: "0.05", token: "USDC" }
}));
```

### 3. Agent间任务委托

```
Agent A (客户) 
    ↓ 发现Agent B (ERC-8004)
    ↓ 检查信誉 (Reputation Registry)
    ↓ 委托任务 (A2A/MCP)
    ↓ 支付 (x402)
    ↓ 验证结果 (Validation Registry)
    ↓ 留反馈
Agent B (服务商)
```

---

## 下一步

1. [x] 理解协议规范
2. [ ] 部署测试Identity Registry (测试网)
3. [ ] 实现简单的x402付费API
4. [ ] 注册小北为ERC-8004 Agent
5. [ ] 发布第一个付费服务

---

## 资源链接

- x402: https://x402.org | https://github.com/coinbase/x402
- ERC-8004: https://eips.ethereum.org/EIPS/eip-8004
- Discussion: https://ethereum-magicians.org/t/erc-8004-trustless-agents/25098
